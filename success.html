<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Success - CodelessAI</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e6edf3;
    }
    .container {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .success-icon {
      width: 64px;
      height: 64px;
      background: #238636;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }
    .success-icon svg { width: 32px; height: 32px; color: #fff; }
    .title { font-size: 24px; font-weight: 700; margin-bottom: 12px; }
    .subtitle { color: #8b949e; font-size: 14px; margin-bottom: 32px; line-height: 1.6; }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      margin: 8px;
    }
    .btn-primary { background: #238636; color: #fff; }
    .btn-primary:hover { background: #2ea043; }
    .btn-secondary {
      background: #21262d;
      border: 1px solid #30363d;
      color: #e6edf3;
    }
    .btn-secondary:hover { background: #30363d; }
    .btn-purple { background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%); color: #fff; }
    .btn-purple:hover { opacity: 0.9; }
    .divider { height: 1px; background: #30363d; margin: 24px 0; }
    .info { font-size: 12px; color: #8b949e; }
    .info a { color: #58a6ff; text-decoration: none; }
    .info a:hover { text-decoration: underline; }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #30363d;
      border-top-color: #58a6ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none; }
    .ide-info {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
      text-align: left;
    }
    .ide-info-title {
      font-size: 13px;
      font-weight: 600;
      color: #58a6ff;
      margin-bottom: 8px;
    }
    .ide-info-text {
      font-size: 12px;
      color: #8b949e;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container" id="loadingState">
    <div class="spinner"></div>
    <h1 class="title">Processing...</h1>
    <p class="subtitle">Please wait while we complete your authentication.</p>
  </div>

  <!-- NEW: Success state for device code flow (works with all IDEs) -->
  <div class="container hidden" id="successStateDevice">
    <div class="success-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
    <h1 class="title">You're all set!</h1>
    <p class="subtitle">
      Your account is ready.<br/>
      You can now close this tab and return to your IDE.
    </p>

    <div class="ide-info">
      <div class="ide-info-title">âœ¨ What happens next?</div>
      <div class="ide-info-text">
        Your IDE will automatically detect the login and sign you in.
        No need to click anything - just go back to your editor!
      </div>
    </div>

    <button class="btn btn-primary" onclick="window.close()">
      Close this tab
    </button>
    <a href="https://codelessai.dev/dashboard" class="btn btn-purple" target="_blank">
      Go to Dashboard
    </a>

    <div class="divider"></div>

    <p class="info">
      Works with VS Code, Cursor, Windsurf, and other VS Code-based IDEs
    </p>
  </div>

  <!-- Legacy: Success state for direct VS Code redirect (fallback) -->
  <div class="container hidden" id="successState">
    <div class="success-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
    <h1 class="title">You're all set!</h1>
    <p class="subtitle">
      Your account is ready.<br/>
      Click below to open VS Code and start coding with CodelessAI.
    </p>

    <a href="#" class="btn btn-primary" id="openVscode">
      Open VS Code
    </a>
    <button class="btn btn-secondary" onclick="window.close()">
      Close this tab
    </button>

    <div class="divider"></div>

    <p class="info">
      VS Code not opening? <a href="#" id="manualLink">Copy the link</a>
    </p>
  </div>

  <div class="container hidden" id="pendingState">
    <div class="success-icon" style="background: #58a6ff;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
        <polyline points="22,6 12,13 2,6"/>
      </svg>
    </div>
    <h1 class="title">Check your email</h1>
    <p class="subtitle">
      We've sent you a confirmation link.<br/>
      Please check your email and click the link to complete signup.
    </p>
    
    <a href="login.html" class="btn btn-secondary">
      Go to Sign In
    </a>
  </div>

  <div class="container hidden" id="errorState">
    <div class="success-icon" style="background: #f85149;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
    </div>
    <h1 class="title">Something went wrong</h1>
    <p class="subtitle" id="errorMessage">
      Authentication failed. Please try again.
    </p>
    
    <a href="login.html" class="btn btn-primary">
      Try Again
    </a>
  </div>
  
  <script>
    const SUPABASE_URL = 'https://sizwtijdyjnamnppcwyy.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpend0aWpkeWpuYW1ucHBjd3l5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MTAwNTIsImV4cCI6MjA4MDI4NjA1Mn0.q64OGNZ6pwpRurZST9Vu0RlKhqGSKhLmoc1Hdto5XGI';
    const DEVICE_AUTH_URL = 'https://sizwtijdyjnamnppcwyy.supabase.co/functions/v1/device-auth';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showState(stateId) {
      ['loadingState', 'successState', 'successStateDevice', 'pendingState', 'errorState'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.toggle('hidden', id !== stateId);
      });
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      showState('errorState');
    }

    function buildVscodeUrl(accessToken, refreshToken) {
      const params = new URLSearchParams({
        access_token: accessToken,
        refresh_token: refreshToken || '',
      });
      return 'vscode://codelessai.codeless-ai/auth?' + params.toString();
    }

    // Complete device auth - store tokens in database for extension to poll
    async function completeDeviceAuth(deviceCode, accessToken, refreshToken, userId) {
      try {
        const response = await fetch(`${DEVICE_AUTH_URL}?action=complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            device_code: deviceCode,
            access_token: accessToken,
            refresh_token: refreshToken,
            user_id: userId,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to complete device auth');
        }

        return true;
      } catch (err) {
        console.error('Device auth completion error:', err);
        return false;
      }
    }

    async function handleAuth() {
      const urlParams = new URLSearchParams(window.location.search);

      // Check for confirmation pending
      if (urlParams.get('confirmation') === 'pending') {
        showState('pendingState');
        return;
      }

      // Check for device_code - this means we're using the new polling flow
      const deviceCode = urlParams.get('device_code');

      // Check for tokens in URL params (from our login page)
      let accessToken = urlParams.get('access_token');
      let refreshToken = urlParams.get('refresh_token');

      // Check hash fragment (from OAuth redirect)
      if (!accessToken && window.location.hash) {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        accessToken = hashParams.get('access_token');
        refreshToken = hashParams.get('refresh_token');

        // Also check for error in hash
        const error = hashParams.get('error_description') || hashParams.get('error');
        if (error) {
          showError(decodeURIComponent(error));
          return;
        }
      }

      // If we have tokens, handle authentication
      if (accessToken) {
        try {
          // Verify the session is valid
          const { data, error } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken || '',
          });

          if (error) throw error;

          const userId = data.user?.id;

          // NEW: If we have a device_code, use the polling flow (works with all IDEs)
          if (deviceCode) {
            const completed = await completeDeviceAuth(deviceCode, accessToken, refreshToken, userId);
            if (completed) {
              showState('successStateDevice');
              return;
            }
            // If device auth failed, fall back to VS Code redirect
          }

          // Legacy: Direct VS Code redirect (only works in VS Code)
          const vscodeUrl = buildVscodeUrl(accessToken, refreshToken);

          document.getElementById('openVscode').href = vscodeUrl;
          document.getElementById('manualLink').onclick = (e) => {
            e.preventDefault();
            navigator.clipboard.writeText(vscodeUrl);
            alert('Link copied to clipboard!');
          };

          showState('successState');

          // Auto-redirect after 1 second
          setTimeout(() => {
            window.location.href = vscodeUrl;
          }, 1000);

        } catch (err) {
          showError(err.message || 'Failed to verify authentication');
        }
      } else {
        // Check if we have an active session (might be from page reload)
        const { data: { session } } = await supabase.auth.getSession();

        if (session) {
          const userId = session.user?.id;

          // NEW: If we have a device_code, use the polling flow
          if (deviceCode) {
            const completed = await completeDeviceAuth(deviceCode, session.access_token, session.refresh_token, userId);
            if (completed) {
              showState('successStateDevice');
              return;
            }
          }

          // Legacy: Direct VS Code redirect
          const vscodeUrl = buildVscodeUrl(session.access_token, session.refresh_token);
          document.getElementById('openVscode').href = vscodeUrl;
          document.getElementById('manualLink').onclick = (e) => {
            e.preventDefault();
            navigator.clipboard.writeText(vscodeUrl);
            alert('Link copied to clipboard!');
          };
          showState('successState');

          setTimeout(() => {
            window.location.href = vscodeUrl;
          }, 1000);
        } else {
          showError('No authentication data found. Please try signing in again.');
        }
      }
    }

    // Run on page load
    handleAuth();
  </script>
</body>
</html>
